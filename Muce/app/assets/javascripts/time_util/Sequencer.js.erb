var Sequencer =  function() {
  var self = this;

var startedrunning = 0; // TODO for testing remove me
  var tempo = 60.0;
  var oneMinute = 60.0;
  var eventQueue = [];
  var nextEventTime = 0.0;
  var currentSubdivision = 4;  // TODO 16ths eg 4 subs per beat this is restrictive, time based is gross, options?
  var currentStepNumber = 0;
  var performanceRunning = false;
  var oneBeatTimeValue = (oneMinute / tempo) ;
  var schedulingLookAhead = 50.0;
  var scheduleEventHorizon = 0.1;
  var sequencerWorker = null;
  var context = window.AudioEnvironment.context;

  function advanceStep() {
    oneBeatTimeValue = (oneMinute / tempo);
    nextEventTime += (1.0 / currentSubdivision) * oneBeatTimeValue;
    db("Next Event Time:  " + nextEventTime );
    currentStepNumber ++;
    if(currentStepNumber == 16) {
      currentStepNumber = 0;
    }
  }

  function scheduleEvent( stepNumber, time ) {
    self.parts.forEach(function(part) {
      part.rhythm.forEach(function(rhythm) {
        if(rhythm){
          db("schdeuling")
          var startTime = nextEventTime;
          var endTime   = nextEventTime + (rhythm * oneBeatTimeValue);
          part.generator.play(startTime, endTime);
        }
      });
    });
  }

  function eventScheduler() {
    db("Lookahead limit"+context.currentTime + scheduleEventHorizon );
    while (nextEventTime < context.currentTime + scheduleEventHorizon ) {
      scheduleEvent( currentStepNumber, nextEventTime );
      advanceStep();
      var runningTime = context.currentTime - startedrunning;
      db("Runngint for " + runningTime + "at " + currentStepNumber);
      // if(context.currentTime - startedrunning > 10.0){ stopPerformance();}
    }
  }

  function startPerformance(parts) {
    startedrunning = context.currentTime;
    self.parts = parts; 
    currentStepNumber = 0;

    nextEventTime = context.currentTime;
    sequencerWorker.postMessage('running');
  }

  function stopPerformance() {
    db("stopping");
    sequencerWorker.postMessage('stop');
  }

  self.run = function(parts) {
    db("Running");
    performanceRunning = !performanceRunning;
    performanceRunning ? startPerformance(parts) : stopPerformance();
  }

  self.updateTempo = function(newTempo) {
    tempo = newTempo;
  }

  self.init = function() {
    db("Initialising sequencer");
    sequencerWorker = new Worker("<%= javascript_path "sequencerWorker.js" %>");

    sequencerWorker.onmessage = function(e) {
      if(e.data == 'step') {
        db("step");
        eventScheduler();
      }
      else {
        db('Received :' + e.data);
      }
    };
    sequencerWorker.postMessage({ "schedulingLookAhead": schedulingLookAhead });
  }

  function db(message) {
    console.log(message);
  }
}
